<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Actor | Blockbuster</title>
    
        <link rel="stylesheet" href="./src/output.css">
        <link rel="stylesheet" href="./src/output.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Pixelify+Sans:wght@400..700&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=Bebas+Neue&family=Pixelify+Sans:wght@400..700&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
</head>
<body class="bg-gradient-to-b from-blockbuster to-blockbuster-700 min-h-screen font-['Roboto']">
    <header class="h-24 bg-blockbuster-900 flex flex-row gap-7 items-center ">
        <a href="start-log.html" class="flex h-16 ml-8">
            <img src="templates/Blockbuster-Symbol.png" alt="">
        </a>
        <a href="actors-add.html"
           class="bg-green-400 text-gray-800 flex gap h-12 w-24 rounded-xl font-body justify-center items-center text-xl p-2 hover:bg-blockbuster-300 hover:transition hover:duration-300 shadow-lg active:scale-95 active:shadow-inner transition-transform"
           style="user-select: none;">
            ADD
        </a>
        <a href="actors-delete.html"
           class="bg-red-400 text-gray-800 flex gap h-12 w-28 rounded-xl font-body justify-center items-center text-xl p-6 hover:bg-red-300 hover:transition hover:duration-300 shadow-lg active:scale-95 active:shadow-inner transition-transform"
           style="user-select: none;">
            DELETE
        </a>
    </header>
    <div class="max-w-xl mx-auto mt-12 bg-white/90 rounded-lg shadow-lg p-8">
        <h1 class="text-4xl font-bold text-blockbuster-700 mb-14 font-['Bebas Neue'] tracking-wide text-center font-body ">
            EDIT ACTOR
        </h1>
        <form id="edit-actor-form" class="space-y-5">
            <div>
                <label class="block text-blockbuster-700 font-semibold mb-1 font-display text-2xl" for="select-actor">Select Name</label>
                <select name="select-actor" id="select-actor" class="w-full px-4 py-2 rounded border border-blockbuster-200 focus:outline-none focus:ring-2 focus:ring-blockbuster-500 bg-blockbuster-50">
                    <option class="font-body" value="">-- Select an actor from the list --</option>
                </select>
            </div>
            <div>
                <label class="block text-blockbuster-700 font-semibold mb-1 font-display text-2xl" for="name-actor">Name</label>
                <input type="text" id="name-actor" class="w-full px-4 py-2 rounded border border-blockbuster-200 focus:outline-none focus:ring-2 focus:ring-blockbuster-500 bg-blockbuster-50" >
            </div>
            <p id="message" class="font-pixel text-center mt-2"></p>
            <div class="flex justify-center">
                <button type="submit" class="bg-blockbuster-700 hover:bg-blockbuster-500 text-white font-bold py-2 px-8 rounded transition-colors duration-200 shadow-md font-display text-2xl">
                    Update
                </button>
            </div>
        </form>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const apiURL = "http://localhost:3001/api/actors";
            const apiURLSingle = "http://localhost:3001/api/actor";
            const form = document.getElementById("edit-actor-form");
            const message = document.getElementById("message");
            const actorSelect = document.getElementById("select-actor");

            async function loadActors() {
                try {
                    const res = await fetch(apiURL);
                    const actors =  await res.json();

                    actorSelect.innerHTML = '<option value=""> --Select an actor --</option>';

                    actors.forEach((actor) => {
                        const option = document.createElement("option");
                        option.value = actor.id;
                        option.textContent = `${actor.name}`;
                        actorSelect.appendChild(option);
                    });

                    console.log(`${actors.length} actors loaded`);


                } catch(error) {
                    message.textContent = "ERROR: Can't load actors";
                    message.classList.add("text-red-500");
                    console.error("ERROR: Can't load actors");

                }
            }

            actorSelect.addEventListener("change", async () => {
                const id = actorSelect.value;
                console.log(id)

                if(!id){
                    document.getElementById("name-actor").value = "";
                    message.textContent = "";
                    message.classList.remove = ("text-red-500", "text-green-500");

                    return;
                }

                try{
                    console.log("Loading actor name");
                    const res = await fetch(`${apiURLSingle}/${id}`);
                    const actor = await res.json();
                    
                    console.log(actor);

                    document.getElementById("name-actor").value = actor.name;
                    message.textContent = "";
                    message.classList.remove("text-red-500", "text-green-500");

                }catch(error){
                    message.textContent = "ERROR: Can't load actor data";
                    message.classList.remove("text-green-500");
                    message.classList.add("text-red-500");
                    console.error("ERROR: Can't load actor data");

                    document.getElementById("name-actor").value = "";
                }

                
            });

            form.addEventListener("submit", async (e) => {
                e.preventDefault();

                const id = actorSelect.value;
                const name = document.getElementById("name-actor").value.trim();

                if(!id){
                    message.textContent = "Please, select an actor";
                    message.classList.remove("text-green-500");
                    message.classList.add("text-red-500");
                    return;
                }

                if(!name){
                    message.textContent = "The actor name is obligatory";
                    message.classList.remove("text-green-500");
                    message.clasList.add("text-red-500");
                    return;
                }

                message.textContent = "Saving updates...";
                message.classList.remove("text-red-500", "text-green-500");
                message.classList.add("text-yellow-500");

                try{
                    const token = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
                    const response = await fetch(`${apiURLSingle}/${id}`, {
                        method: "PUT",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": token ? `Bearer ${token}` : "",
                        },
                        body: JSON.stringify({
                            name
                        }),
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                    
                        message.textContent = "Actor updated successfully";
                        message.classList.remove("text-red-500");
                        message.classList.add("text-green-500");
                    
                        console.log("Actor updated", result);

                        const selectedOption = actorSelect.querySelector(
                            `option[value="${id}"]`
                        );
                        loadActors();
                        document.getElementById("name-actor").value = "";

                        if(selectedOption) {
                            selectedOption.textContent = `${name}`;
                        }
                    } else{
                        const errorData = await response.json();
                        message.textContent = "ERROR: Can't update the actor";
                        message.classList.remove("text-green-500");
                        message.classList.add("text-red-500");
                        console.error("Server error" + error);

                    }                                
                }catch(error){
                    console.log(response);
                    console.log(id);
                    message.textContent = "Conection error check the server status";
                    message.classList.remove("text-green-500");
                    message.classList.add("text-red-500");
                    console.error("Server erorr" ,error);
                }

            });
            loadActors();
    });

    </script>
</body>
</html>
